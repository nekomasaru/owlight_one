# Knowledge Creation V2 & AI Support Architecture

本ドキュメントは、ナレッジ作成機能およびAI支援機能の次期アップデート（V2）に関する設計およびアーキテクチャ定義です。

## 1. ユーザー体験 (UX) の基本原則

### "Search First" アプローチ
ユーザー体験を分断させないため、独立した「新規登録」メニューよりも、**「検索・対話」からの自然な移行**をメイン導線とします。

1.  **Search / Ask (入口)**
    *   ユーザーはまずAIチャットや検索窓で疑問を解決しようとする。
2.  **Not Found / Unsolved (分岐点)**
    *   AIが答えられない、または検索結果が0件（もしくは役に立たない）だった場合。
3.  **Action (出口)**
    *   このタイミングで、ユーザーの状態に合わせて2つのアクションを提示する。
    *   **A. ナレッジを作成する (Self-Service)**: 「答えを見つけた/知っている」場合 → AI支援付き作成画面へ。
    *   **B. ナレッジをリクエストする (Demand)**: 「答えが分からない」場合 → 詳しい人への執筆依頼（未解決ニーズとして記録）。

---

## 2. AI支援アーキテクチャ
(2026-01-30 Update: Hybrid Authentication Strategy)
- **Search (RAG)**: Standard Vertex AI SDK (ADC Authentication).
- **Generation (Gemini)**: REST API (API Key Authentication).
  - Reason: 最新モデル (`gemini-2.5-flash-lite`) のリージョン可用性と、SDKの認証周りのトラブルを回避するため、生成系のみAPI Key方式を採用しています。

### Intent-Based Dynamic Prompts (意図駆動型プロンプト)
ユーザーに「プロンプト」を選択させるのではなく、**「どう手伝ってほしいか」**という自然言語やコンテキストから、システムが裏側で最適なプロンプトを選択・実行します。

### Relevance Threshold (検索スコア閾値)
ベクトル検索特有の「無関係なドキュメントでも無理やりヒットする」問題を防ぐため、検索API側でスコア閾値を設定します。
- **Threshold**: `0.6` (暫定値)
- **Logic**: Vertex AI Search のスコアが閾値を下回る場合、その結果を除外します。全て除外された場合は「0件 (Not Found)」として扱い、作成フローへ誘導します。

#### UIイメージ
**Side-by-Side (左右分割) レイアウト** を採用します。
*   **左 (Main)**: ナレッジ入力フォーム。**ウィザード形式**（基本情報 > 背景 > 具体例）を採用し、最終ステップのみ保存が可能。
*   **右 (Sidebar)**: AIアシスタント（チャット）。**リサイズ機能**および**開閉トグル**を備え、開閉時もチャットの状態（履歴）を**継続保持 (Persistence)** する。
*   **Workflow**: 対話 (Chat) → 生成 (Generate) → 反映 (Apply/Overwrite) → ウィザード進行 (Next) → 保存 (Save) の反復フロー。

#### 処理フロー
1.  **User Input**: 「このPDFを要約して」「もっと具体例を足して」「堅い表現にして」
2.  **Intent Analysis**: 入力内容と状況（ファイル有無、現在地）から意図を解析。
3.  **Prompt Selection**: 対応するバックエンド処理を実行。

#### パターン定義
| パターン | ユーザーの意図 (Intent) | 処理内容 |
| :--- | :--- | :--- |
| **A. Generate (ゼロベース生成)** | 「〇〇について書きたい」 | 一般論(LLM)から骨子を作成 |
| **B. Refine (整形・清書)** | 「メモ書きを綺麗にして」 | 雑多なテキストを行政文書/マニュアル調に変換 |
| **C. Summarize (要約・蒸留)** | 「ファイルを元にして」 | アップロードファイルを解析し構造化データへ変換 |
| **D. Enrich (統合・補強)** | 「関連情報を足して」 | Vertex AI Search (RAG) から社内規定などを引用・補強 |

---

## 3. 具体的な機能要件

### 3.1 ファイルアップロードの保存オプション
AIのコンテキストとしてファイルを読み込ませる際、そのファイルの扱いを選択可能にする。

*   **UI**: アップロードダイアログにチェックボックスを配置。
*   **オプション**:
    *   `[ ] 添付資料として保存する`: GCSに保存し、ナレッジと紐付ける（証跡として残る）。
    *   `[ ] 一時利用のみ`: テキスト抽出とAI解析にのみ使用し、保存しない（個人的なメモなど）。

### 3.2 検索結果0件時の「ナレッジ執筆リクエスト」
自分が答えを持っていない場合の受け皿を作る。

*   **機能**: 検索キーワードや、知りたかった内容を「リクエスト」として登録。
*   **活用**: 管理者やSME（Subject Matter Expert）がリクエスト一覧を見て、優先的にナレッジ化する。

### 3.3 リアルタイム重複検知 (Real-time De-duplication)
作成中の「タイトル」入力などにフックして、裏側で検索を実行。

*   **UI**: 類似ナレッジが見つかった場合、控えめに提示（「似たナレッジがあります: ...」）。
*   **効果**: 重複登録の防止、および既存ナレッジへの追記・修正への誘導。
